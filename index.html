<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Force No Cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Cocina (Live)</title>
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
  <div id="initLoader"><div class="spinner"></div><div style="opacity:0.8">Conectando...</div></div>

  <div class="admin-shell">
    <header class="card" style="margin:10px;padding:15px;display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="assets/logo-mark.png" style="height:40px">
        <div><h1 style="font-size:18px;margin:0">Cocina</h1><div id="locName" style="font-size:12px;opacity:0.7">...</div></div>
      </div>
      <div style="display:flex;gap:8px">
        <div id="rt" style="width:10px;height:10px;border-radius:50%;background:red;margin-top:15px"></div>
        <button id="ref" class="btn secondary" style="width:auto;min-height:40px;font-size:14px">↻</button>
        <button id="cfg" class="btn" style="width:auto;min-height:40px;font-size:14px">⚙</button>
      </div>
    </header>

    <main class="admin-main" style="padding:10px;overflow-y:auto;height:calc(100vh - 90px)">
      <div id="debugLog" style="color:red;font-size:10px;display:none;margin-bottom:10px;"></div>
      <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px"></div>
      <div id="empty" class="hidden" style="text-align:center;padding:50px;opacity:0.6"><h2>Sin Órdenes</h2></div>
    </main>
  </div>

  <div id="pinModal" class="modal-overlay hidden">
    <div class="modal card">
      <h2 style="text-align:center">Acceso</h2>
      <div id="pinDisp" class="pin-screen"></div>
      <div class="pin-pad">
        <button class="pin-key" data-k="1">1</button><button class="pin-key" data-k="2">2</button><button class="pin-key" data-k="3">3</button>
        <button class="pin-key" data-k="4">4</button><button class="pin-key" data-k="5">5</button><button class="pin-key" data-k="6">6</button>
        <button class="pin-key" data-k="7">7</button><button class="pin-key" data-k="8">8</button><button class="pin-key" data-k="9">9</button>
        <button class="pin-key" data-k="C">C</button><button class="pin-key" data-k="0">0</button><button class="pin-key" data-k="OK">OK</button>
      </div>
      <button class="btn secondary" id="pinCancel" style="margin-top:10px">Cancelar</button>
    </div>
  </div>

  <script type="module">
    import { getClient, getEnv, verifyPin } from "./js/supabase.js";

    // KILL SWITCH: Force removal of all Service Workers
    if(window.navigator && navigator.serviceWorker) {
      navigator.serviceWorker.getRegistrations()
      .then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
          console.log("Service Worker Killed");
        }
      });
    }

    const els = { loader:document.getElementById('initLoader'), grid:document.getElementById('grid'), loc:document.getElementById('locName'), rt:document.getElementById('rt'), empty:document.getElementById('empty'), debug:document.getElementById('debugLog') };
    const env = getEnv();
    const supabase = getClient();
    let pin = "";

    function logError(msg) {
        els.debug.style.display = 'block';
        els.debug.innerHTML += `ERROR: ${msg}<br>`;
        alert(msg); // Force alert on tablet
    }

    window.onload = async () => {
      if(!env.locId || !supabase) return location.href='ajustes.html';
      els.loc.textContent = env.locName;
      await fetchOrders();
      
      supabase.channel('kitchen_live')
        .on('postgres_changes', {event:'*', schema:'public', table:'orders', filter:`location_id=eq.${env.locId}`}, fetchOrders)
        .subscribe(s => els.rt.style.background = s==='SUBSCRIBED'?'#2ecc71':'red');
        
      els.loader.style.display='none';
    };

    async function fetchOrders() {
      const { data, error } = await supabase.from('orders').select('*, order_items(*, menu_items(name))')
        .eq('location_id', env.locId).in('status',['pending','preparing','ready']).order('created_at');
      
      if(error) logError("Fetch: " + error.message);
      else render(data||[]);
    }

    function render(list) {
      els.grid.innerHTML='';
      if(!list.length) els.empty.classList.remove('hidden');
      else els.empty.classList.add('hidden');

      list.forEach(o => {
        const d = document.createElement('div');
        d.className='card'; d.style.padding='15px';
        const items = o.order_items.map(i => `<div style="display:flex;justify-content:space-between;margin-top:5px;border-bottom:1px solid #333;padding-bottom:5px"><b>${i.qty}</b><span>${i.menu_items?.name}</span></div>`).join('');
        
        let btn = `<button class="btn" onclick="window.upd('${o.id}','preparing')">Preparar</button>`;
        if(o.status==='preparing') btn=`<button class="btn secondary" onclick="window.upd('${o.id}','ready')">Listo</button>`;
        if(o.status==='ready') btn=`<button class="btn ghost" onclick="window.upd('${o.id}','closed')">Cerrar</button>`;

        d.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:10px">
          <span class="badge">${o.order_type==='dine_in'?'Mesa '+o.table_number:'Llevar'}</span>
          <span style="font-size:12px;opacity:0.7">${new Date(o.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div style="margin-bottom:15px">${items}</div>
        ${o.customer_note ? `<div style="background:#b0191f;padding:5px;border-radius:5px;margin-bottom:10px;font-size:13px">${o.customer_note}</div>` : ''}
        ${btn}`;
        els.grid.appendChild(d);
      });
    }

    window.upd = async (id, s) => {
      // Direct update, no policies should block this if SQL step 1 was run
      const { error } = await supabase.from('orders').update({status:s}).eq('id',id);
      if(error) {
        logError("Update Failed: " + error.message + " (Code: " + error.code + ")");
      } else {
        fetchOrders();
      }
    };

    document.getElementById('ref').onclick = fetchOrders;
    document.getElementById('cfg').onclick = () => document.getElementById('pinModal').classList.remove('hidden');
    document.getElementById('pinCancel').onclick = () => { document.getElementById('pinModal').classList.add('hidden'); pin=''; document.getElementById('pinDisp').textContent=''; };
    document.querySelectorAll('.pin-key').forEach(b => b.onclick = () => {
      const k = b.dataset.k;
      if(k==='C') pin="";
      else if(k==='OK') { if(verifyPin(pin, env.locName)) location.href='ajustes.html'; else { pin=""; alert('Incorrecto'); } }
      else if(pin.length<4) pin+=k;
      document.getElementById('pinDisp').textContent = "•".repeat(pin.length);
    });
  </script>
</body>
</html>
